---
title: "species_tree_Q10"
author: "ML"
date: "17/11/2019"
output: html_document
---

*NOTE:* not tested for knitting

```{r setup, cache = F, echo=FALSE, results = FALSE}
knitr::opts_chunk$set(error = TRUE) #allow some execution errors
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, warning = FALSE)
sessionInfo()
```

```{r prepare, message = FALSE, echo = TRUE, eval = FALSE, warning = FALSE}
install.packages("tidyverse")
install.packages("ape")
install.packages("curl")
install.packages("fulltext")
install.packages("treebase")
install.packages("devtools")
devtools::install_github("ropensci/rotl", dependencies = TRUE, build_vignette=TRUE)
install.packages("rotl")
install.packages("kutlis")
```

```{r load packages, message = FALSE, echo = TRUE, eval = TRUE, warning = FALSE}
library(tidyverse)
library(ape, curl)
library(rotl)
library(kutils) #https://rdrr.io/cran/kutils/man/mgsub.html
```

```{r load data, message = FALSE, echo = TRUE, eval = TRUE, warning = FALSE}
setwd("/Users/itchyshin/Dropbox/Losia-Shinichi/LAB/MA_general/trees_other/Shin_Q10")
dat <- read.csv("species_list_Q10.csv")
str(dat)
myspecies <- as.character(unique(dat$species_full)) #get list of species
str_sort(myspecies) #visual check
length(myspecies) #239 species
length(unique(myspecies)) #239 unique species names (does not account for synonyms)
```

## Using *rotl* package to retrieve synthetic species tree from Open Tree of Life

Rotl is an R package (https://peerj.com/preprints/1471/) allowing access to synthetic phylogenetic tree available at Open Tree of Life database (https://opentreeoflife.org/).   

```{r rotl find species, message = FALSE, echo = TRUE, eval = TRUE, warning = FALSE, }
taxa <- tnrs_match_names(names = myspecies)
#Warning message: Enithares sp are not matched
dim(taxa) #239
table(taxa$approximate_match) #234 + 4 = 238, one row is NA, i.e. no match (Enithares sp)
#taxa[taxa$approximate_match==TRUE, ] #4 rows with approximate matches
```

Temporarily replace Enithares sp with Enithares ciliata

```{r rotl replace and find species, warning = FALSE, results=FALSE, eval = TRUE}
myspecies2 <- gsub("Enithares sp", "Enithares ciliata", myspecies)
taxa2 <- tnrs_match_names(names = myspecies2)
dim(taxa2) #239
table(taxa2$approximate_match) #235 + 4 = 239, all matched, but 4 are approximate
```

Get the initial tree.  

```{r rotl species tree, warning = FALSE, results=FALSE}
tree <- tol_induced_subtree(ott_ids = taxa2[["ott_id"]], label_format = "name")  
#Error: HTTP failure: 400 [/v3/tree_of_life/induced_subtree] Error: node_id 'ott276728' was not found!list(ott276728 = "pruned_ott_id")
taxa2[taxa2$ott_id==276728, ] #Lithasia obovata - uncertain naming and position?
#OTOL explanation: This taxon is in our taxonomy but does not appear in the latest synthetic tree. This can happen for a variety of reasons, but the most probable is that is has a taxon flag (e.g. incertae sedis) that causes it to be pruned from the synthetic tree.
#https://tree.opentreeoflife.org/taxonomy/browse?id=231740
#https://tree.opentreeoflife.org/taxonomy/browse?id=670621
```

Temporarily replace Lithasia obovata with Aspella anceps (all genus Lithasia is hidden_inherited, same for all Pleuroceridae and a few levels up, Aspella is another snail from Neogastropoda). ALso fix Fundulus heteroclitus to match the name in OTOL database.

```{r rotl replace and find species again, warning = FALSE, results=FALSE, eval = TRUE}
myspecies2 <- gsub("Lithasia obovata", "Aspella anceps", myspecies2)
myspecies2[myspecies2=="Fundulus heteroclitus"] <-"Fundulus heteroclitus heteroclitus" #use subspecies name (diff syntax used due to double-matching)
```

```{r check for duplicated species - synonymous names, warning = FALSE, results=FALSE, eval = TRUE}
length(unique(taxa2[["ott_id"]])) #238
taxa2[duplicated(taxa2[["ott_id"]])==TRUE,] #check for non-unique ID's (some potential species synonyms)
taxa2[taxa2$ott_id == 829098,] #Chinemys reevesii = Mauremys reevesii

#change in the original species list to get rid of the synonyme! (IMPORTANT - CHANGE ALSO IN THE ORIGINAL DATASET)
myspecies2 <- gsub("Chinemys reevesii", "Mauremys reevesii", myspecies2)
length(unique(myspecies2)) #238
myspecies2 <- unique(myspecies2)
```

Get second tree for 238 unique species. 

```{r rotl species tree2, warning = FALSE, results=FALSE}
taxa2 <- tnrs_match_names(names = myspecies2)
#taxa2
dim(taxa2) #238

tree2 <- tol_induced_subtree(ott_ids = taxa2[["ott_id"]], label_format = "name")  
#plot(tree2, cex=.6, label.offset =.1, no.margin = TRUE)
```

Check matching species and clean the tree

```{r re-check and reverse tree labels}
#make copies
tree3 <- tree2
taxa3 <- taxa2

#remove comments from taxa3$unique_name and tree3$tip.label
taxa3$unique_name <- gsub(" \\(.*", "", taxa3$unique_name) #remove comments
tree3$tip.label <- gsub(" \\(.*", "", tree3$tip.label) #remove comments
tree3$tip.label <- gsub("_"," ", tree3$tip.label) #get rid of the underscores

#check overlap and differences
intersect(tree3$tip.label, taxa3$unique_name) #237
setdiff(tree3$tip.label, taxa3$unique_name) #1 - Osmerus
setdiff(taxa3$unique_name, tree3$tip.label) #1 - Osmerus

#fix Osmerus on tree3$tip.label
tree3$tip.label <- gsub("Osmerus", "Osmerus mordax", tree3$tip.label)

#check overlap and differences
intersect(tree3$tip.label, taxa3$unique_name) #238
setdiff(tree3$tip.label, taxa3$unique_name) #0
setdiff(taxa3$unique_name, tree3$tip.label) #0
#now tip labels match exactly unique_name used by OTOL

#capitalise first letter in search string (names in the original dataset, except few changes we made to make the search work)
taxa3$search_string <- paste(toupper(substr(taxa3$search_string, 1, 1)), substr(taxa3$search_string, 2, nchar(taxa3$search_string)), sep="")

#check overlap and differences between tree tips labels names and search string names (names in the original dataset, except few changes we made to make the search work)
intersect(taxa3$search_string, tree3$tip.label) #208
setdiff(taxa3$search_string, tree3$tip.label) #30
setdiff(tree3$tip.label, taxa3$search_string) #30

#substitute names in tree tip labels to these from search string, based on unique name match
tree3$tip.label <- kutils::mgsub(taxa3$unique_name, taxa3$search_string, tree3$tip.label)

#re-check overlap and differences with search string
intersect(taxa3$search_string, tree3$tip.label) #2238
setdiff(taxa3$search_string, tree3$tip.label) #0
setdiff(tree3$tip.label, taxa3$search_string) #0

#check overlap and differences with myspecies list
intersect(myspecies, tree3$tip.label) #235
setdiff(myspecies, tree3$tip.label) #3
setdiff(tree3$tip.label, myspecies) #3

#make changes on tree3 to match exactly names in myspecies (except the sysnomym)
tree3$tip.label <- gsub("Fundulus heteroclitus heteroclitus", "Fundulus heteroclitus", tree3$tip.label)
tree3$tip.label <- gsub("Aspella anceps", "Lithasia obovata", tree3$tip.label)
tree3$tip.label <- gsub("Enithares ciliata", "Enithares sp", tree3$tip.label)

#re-check overlap and differences with myspecies list
intersect(myspecies, tree3$tip.label) #238
setdiff(myspecies, tree3$tip.label) #"Chinemys reevesii" - synonymous species name (not in the tree)
setdiff(tree3$tip.label, myspecies) #0
#tree labels are now mayching these in myspecies list, except "Chinemys reevesii"


#check if the tree is really binary 
is.binary.tree(tree3) #FALSE (i.e. there are polytomies) - a few small polytomies very close to the tree tips
#resolve polytomies randomly to make binary tree
tree_binary <- multi2di(tree3, random = TRUE)
is.binary.tree(tree_binary) #TRUE
# tree_binary$node.label <- NULL #you can delete internal node labels
# *NOTE:* no branch lengths are included, they can be created later via simulations.   
```

Save tree

```{r save final tree}
write.tree(tree_binary, file="tree_binary_SN_Q10.tre") #save the tree

# *NOTE:* underscores within species names on tree tip labals are added automatically
# tree <- read.tree(file="tree_binary_SN_Q10.tre") #if you need to read in the tree
# tree$tip.label <- gsub("_"," ", tree$tip.label) #get rid of the underscores
# tree$node.label <- NULL #you can delete internal node labels
```

Plot tree

```{r plot final binary tree, fig.width=10, fig.height=20, echo=TRUE, message=FALSE}
plot(tree_binary, cex=.6, label.offset =.1, no.margin = TRUE)

#or plot to pdf
pdf("plot_tree3_SN_Q10.pdf", width=8, heigh=30)
plot(tree_binary, cex=0.6, label.offset =.1, no.margin = TRUE)
dev.off()
```

*FINAL NOTE:*
"Chinemys reevesii" has to be replaced with "Mauremys reevesii" in the original data, as it is a synonym (only "Mauremys reevesii" appears on the tree). Also, "Lithasia obovata" was changed to "Aspella anceps", "Osmerus" to "Osmerus mordax", but should be on tree, but check anyway.




