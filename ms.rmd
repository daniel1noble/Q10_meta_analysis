---
title: ""
author: Daniel W.A. Noble, Fonti Kar, Frank Seebacher, Alex Bush, & Shinichi Nakagawa
date: "`r Sys.Date()`"
bibliography: ./bib/refs.bib
csl: ./bib/ecology-letters.csl
output: 
  bookdown::word_document2:
    toc: no
    toc_depth: 6
    number_sections: false
    reference_docx: ./bib/template.docx
  bookdown::html_document2:
    code_folding: hide
    number_sections: no
    toc: yes
    toc_depth: 6
    toc_float: yes
    bibliography: refs.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, tidy = TRUE, fig.width = 10)
## numbers >= 10^5 will be denoted in scientific notation,		  ## numbers >= 10^5 will be denoted in scientific notation,
  ## and rounded to 2 digits		  ## and rounded to 2 digits
  options(digits = 2)

##################################
# Clean workspace
##################################
    rm(list=ls())

##################################
# Loading packages & Functions
##################################
    pacman::p_load(tidyverse,  metafor, flextable, raster, rasterVis,  patchwork, RColorBrewer, ggtree, ape, phytools, viridis, MCMCglmm, brms, latex2exp, orchaRd, multcomp, ggbeeswarm)

#devtools::install_github(repo = "ErikKusch/KrigR")
## Function to produce colour palette
# Note that temp is stored as a factor of 10 C larger, so needs to be divided. Also, we can greate a custom colour palelte function using colorRampPallette
colfunc <- colorRampPalette(rev(brewer.pal(10,"RdBu")))
#test colfunc(10) will generate the exact Hex codes for 10 different colours can 10 to 100 and you get 100 colour hex codes. Very useful webpage: https://pjbartlein.github.io/REarthSysSci/rasterVis01.html

    # loading functions
    source("./R/functions.R")

```


```{r data_setup_summary, echo = FALSE, results="hide"}

##########################
## Load processed datasets
##########################
data_wide <- read.csv("./output/data/data_final_wide.csv")
data_long <- read.csv("./output/data/data_final_long.csv")

data_long2 <- data_long %>% mutate(type = factor(type, levels = c("acute", "acclim")))

##########################
## Summarize data
##########################

 data_wide$lat <- as.numeric(data_wide$lat)
    new_papers <- data_wide[-grep("_o", data_wide$record_num),]
    old_papers <- data_wide[grep("_o", data_wide$record_num),]
  
    # habitat
      spp_habitat <- data_wide %>%
                      group_by(habitat) %>%
                      summarise(spp_n = length(unique(species_full)))
      tot_spp <- sum(spp_habitat[,2])

#########################
## Phylogeny
#########################
 ## Tree data
    tree_data <-  data_long %>%
                  group_by(species_full)                                                 %>%
                  mutate(n = length(habitat))                                            %>%
                  dplyr::select(species_full,  habitat, n)                               %>% 
                  distinct(species_full, habitat, n)
    #rownames(tree_data) <- tree_data$species_full
    #tree_data <- tree_data[,2:3]
    
 ## Load the phylogenetic tree
                tree <- read.tree("./tree/tree_binary_SN_Q10.tre")   
      tree$tip.label <- gsub("_", " ", tree$tip.label)
      tree$tip.label <- gsub("Enithares sp", "Enithares ciliata", tree$tip.label)
  
      # Do a tree check with original data
          tree_checks(data_long, tree, dataCol = "species_full", type = "checks") 

##################################
# Tree checking and pruning
##################################
  # Have a look at species in data and tree. 
  tree <- tree_checks(data_long, tree, dataCol = "species_full", type = "prune")
      
# Check that taxa dropped
  tree_checks(data_long, tree, dataCol = "species_full", type = "checks")

##################################
# Branch lengths and cor matrix
##################################
      # Now that we have the tree file, we need to use it to create a phylogenetic correlation matrix using Grafen's method. This assumes Brownian motion and is the best we can do without a molecular phylogeny. The topology of the tree should be fairly good. We will explore a few different options with p to determine the best power function
      
        tree_p1 <- compute.brlen(tree, method = "Grafen", power = 1)
      tree_p0.7 <- compute.brlen(tree, method = "Grafen", power = 0.7) # Probably most sensible power
        
     # Create null nodes 
        tree_p1$node.label <- NULL # We don't use nodes and will cause a warning so create null node names
      tree_p0.7$node.label <- NULL # We don't use nodes and will cause a warning so create null node names
```

## Materials and Methods
### *Literature collection*
We compiled literature on ectothermic animals that measured physiological rates (e.g., metabolic rate) at two or more temperatures after having been acclimated (or acclimatized) at these temperatures. We used data from a previous meta-analysis [@Seebacher2015] and updated @Seebacher2015's data by extracting data from suitable studies from our own searches that followed the same search protocol. More specifically, we performed a literature search on the 28th of June 2017 using the Web of Science database. We limited our search to articles or proceedings papers published in English from 2013 to 2017 [the date after @Seebacher2015 searches were conducted] using the following topic search string: *"(acclimat* AND (therm* OR temp*) NOT (plant* OR tree* OR forest* OR fung* OR mammal* OR marsup* OR bird* OR human OR exercis* OR train* OR hypoxi*))"*. We further limited to the following research areas: Anatomy Morphology; Biodiversity Conservation; Biology; Ecology; Endocrinology Metabolism; Entomology; Evolutionary Biology; Marine Freshwater Biology; Physiology; Respiratory System, Reproductive Biology, Zoology. 

Our search resulted in 1,321 papers for screening in Rayyan [@ouzzani2016]. We also cross-checked papers we found in our searches with a recent paper by @Havird2020, which also updates  @Seebacher2015's dataset. We included any papers that were missed between our searches and those of @Havird2020 from the dates 2013-2017. @Havird2020 added 7 new studies between 2013-2017 (mainly because they were focused on metabolic rates), and our searches differed from theirs by only a single paper [i.e., @Bulgarella2015]. Given the physiological traits we included were broader, we had a substantial increase in additional papers that we added to @Seebacher2015's dataset. More specifically, in addition to the `r length(unique(old_papers$record_num))` papers we included from the @Seebacher2015 dataset, we extracted data from an extra `r length(unique(new_papers$record_num))` papers (with a total of `r dim(new_papers)[1]` effects) that were published between 2013 - 2017 (a `r  (length(unique(new_papers$record_num)) / length(unique(old_papers$record_num)))*100`% increase in the number of published articles). Note that @Seebacher2015 included a total of 205 publications, however, not all these contained the necessary statistics we needed to derive $Q_{10}$ effect sizes and associated sampling variances (see below). While we may have missed papers, our goal was to obtain a large representative (and unbiased) sample of acclimation research rather than a comprehensive dataset. As such, our database represents the most up-to-date dataset used by @Seebacher2015 to answer questions on acclimation across ectotherms. 

We split the screening of titles and abstracts for the 1,321 papers found in our search among all authors evenly. To ensure consistency among authors in title and abstracts that should be included, prior to  screening all authors went through a randomly selected set of papers together - agreeing on those that were relevant and those that were not based on our inclusion criteria (see below). Where any authors were uncertain about whether to include a paper in the sub-sample they screened, we conservatively included the paper for full text screening and discussed uncertain papers among authors to come to a decision on whether to include the paper. After title and abstract screening, we were left with a total of 149 papers for full text screening. Papers were included only if they: 1) measured a physiological rate acutely at two temperatures on a sample of animals chronically exposed to the same two temperatures for at least 1 week; and 2) where physiological rates measured were burst and sustained locomotion, metabolic rates (standard, resting, routine and maximal), heart rates, and/or enzyme activities. 

### *Data Compilation*

We extracted means, standard deviations and sample sizes for physiological rates at the two test temperatures. If there were more than two test temperatures, we choose only the test temperatures that fell within the most likely natural range of temperatures experienced by the species in question. We extracted these data from text, tables or figures of a given paper. Data were extracted from figures using the R package *metaDigitise* [@Pick2019]. We also recorded the phylum, class, order, genus and species under study and the latitude and longitude of the population that was being studied. For studies that did not provide latitude and longitude for the population, we searched for similar studies by the lab group to identify where the population was likely to have been sourced or derived from when needed. If the population was derived from the wild, we recorded the nearest latitude and longitude of the population to the field collection site. If the animals had been sourced from a commercial supplier, we took the latitude and longitude of the supplier that the paper identified the animals to have originated from. When it was not possible to find latitude and longitude using these methods, we looked up the distribution of the species in question and took the latitude and longitude of the centroid of the species' distributional range. 

### *$Q_{10}$ Based Effect Sizes and Sampling Variances for Means and Variances*

Following @Noble2022 we calculated a series of temperature corrected effect sizes that compared mean physiological rates ($lnRR_{Q_{10}}$) as well as the variability in physiological rates ($lnVR_{Q_{10}}$ and $lnCVR_{Q_{10}}$). These effect sizes are essentially similar to the traditional temperature coefficient ($Q_{10}$), but with formal analytical approximations for their sampling variances. Sampling variances for effect sizes allowed us to make use of traditional meta-analytic modelling approaches. 

#### *Comparing changes in mean physiological rates*

To compare mean physiological rates we calculated the log $Q_{10}$ response ratio, $lnRR_{Q_{10}}$ [@Noble2022] as follows:

$$
\begin{equation} 
  lnRR_{Q_{10}} = ln\left( \frac{R_{2}}{R_{1}} \right){ \left(\ \frac{10^{\circ}C}{T_{2}-T_{1}} \right) }
(\#eq:lnq10)
\end{equation} 
$$


Where, $R_{1}$ and  $R_{2}$ are mean physiological rates and  $T_{1}$ and  $T_{2}$ are the temperatures that these rates are measured. Log transformation of this ratio makes the effect size normally distributed. Equation \@ref(eq:lnq10) is essentially a temperature corrected equivalent to the log response ratio (lnRR) [@hedges1999meta; @laj2011] when the numerator and denominator are measured at different temperatures. This allows one to compare the mean of two temperature treatments directly regardless of the temperatures that these groups have been measured. The sampling variance for equation \@ref(eq:lnq10) can be computed as follows (as described in @Noble2022):

$$
\begin{equation} 
  s_{lnRR_{Q_{10}}} = \left( \frac{SD_{2}^2}{R^2_{2}N_{2}} + \frac{SD_{1}^2}{R^2_{1}N_{1}} \right){ \left(\ \frac{10^{\circ}C}{T_{2}-T_{1}} \right) }^2
  (\#eq:Vlnq10)
\end{equation} 
$$

Here, $SD_{1}^2$ and $SD_{2}^2$ are the standard deviations and $N_{1}$ and $N_{2}$ are the sample sizes in group 1 and 2, respectively.

#### *Comparing variance physiological rates*
 @nakagawa2015meta recently proposed analogous effect size estimates to *lnRR* that allow for comparisons of changes in variance between two groups, the log variance ratio (*lnVR*) and the log coefficient of variation (*lnCVR*). *lnVR* and *lnCVR* are ratios that describe the relative difference in trait variability between two groups. We refer readers to @nakagawa2015meta for the equations describing *lnVR* and *lnCVR*, but these can easily be extended to their $Q_{10}$ analogues (and associated sampling variance) as follows:

$$
\begin{equation} 
lnVR_{Q_{10}} = ln\left( \frac{SD_{2}}{SD_{1}} \right){ \left(\ \frac{10^{\circ}C}{T_{2}-T_{1}} \right) }
(\#eq:lnq10VR)
\end{equation} 
$$
$$
\begin{equation} 
s_{lnVR_{Q_{10}}} = \left( \frac{1}{2\left( N_{2}-1 \right)} + \frac{1}{2\left(N_{1} - 1\right)} \right){ \left(\ \frac{10^{\circ}C}{T_{2}-T_{1}} \right) }^2
(\#eq:slnq10VR)
\end{equation} 
$$

Equations \@ref(eq:lnq10VR) and \@ref(eq:slnq10VR) describe the change in physiological rate variance (eqn \@ref(eq:lnq10VR)) across a 10&deg;C temperature change along with its sampling variance (eqn \@ref(eq:slnq10VR)). While this is a useful metric, as discussed by @nakagawa2015meta there is often a strong mean-variance relationship that needs to be accounted for in analysing changes in variance. As such, we calculated the coefficient of variation, which standardizes changes in variance for changes in means as follows:

$$
\begin{equation} 
lnCVR_{Q_{10}} = ln\left( \frac{\text{CV}_{2}}{\text{CV}_{1}} \right){ \left(\ \frac{10^{\circ}C}{T_{2}-T_{1}} \right) }
(\#eq:lnq10CVR)
\end{equation} 
$$
$$
\begin{equation} 
s_{lnCVR_{Q_{10}}} = \left[ \frac{(\text{SD}_{1})^2}{N_{1}({R}_{1})^2} + \frac{(\text{SD}_{2})^2}{N_{2} ({R}_{2})^2} + \frac{1}{2\left( N_{1}-1 \right)} + \frac{1}{2\left(N_{2} - 1\right)} \right]{ \left(\ \frac{10^{\circ}C}{T_{2}-T_{1}} \right) }^2
(\#eq:slnq10CVR)
\end{equation} 
$$

where $CV$ is the coefficient of variation defined as $SD / R$. 

#### *Calculating acute and acclimation $lnRR_{Q_{10}}$, $lnVR_{Q_{10}}$ and $lnCVR_{Q_{10}}$ estimates*
Using the mean, standard deviation and sample size for all acute and acclimation treatments of studies in our databases we derived acute and acclimation $lnRR_{Q_{10}}$, $lnVR_{Q_{10}}$ and $lnCVR_{Q_{10}}$ estimates. For all effect sizes the higher acute or acclimation temperature was in the numerator and the lower of the two temperatures in the denominator. As such, positive effect sizes suggest that the mean or variance is larger at the higher of the two temperatures, standardized to 10&deg;C. 

### *Moderator Variables*

We recorded or derived a series of moderator variables from each study that are expected to have an impact on our effect size estimates. These included the duration of acclimation in days and acclimation type ("acclimation" or "acclimatization") given that acclimation responses are expected to depend both on how long chronic temperature exposure occurs (longer exposure = better acclimation response) and whether exposure took place in the wild ("acclimatized") or lab ("acclimated") [@Seebacher2015]. We also recorded if the sample of animals were derived from captive or wild stocks, the life-history stage of the animals used ("adult" or "juvenile") and the habitat type ("freshwater", "marine" or "terrestrial") given that @Seebacher2015 show that these factors can impact $Q_{10}$ estimates. Physiological rate measures varied widely across the studies but could generally be grouped into discrete trait categories [@Seebacher2015]. As such, using the detailed information on the trait type and its associated units from a given study we categorized each effect size into one of 12 trait categories. These categories included measures of whole organism performance measures including cardiac (i.e., 'cardiac') and muscle ('muscle') function, sprint speed ('sprint') and endurance ('endurance') and metabolic rates (i.e., maximal and resting metabolic rate; max MR', 'rest MR', respectively). Studies also quantified various enzymatic reaction rates, including enzymes involved in general metabolic responses (categorized as 'metabolic enzyme'), various parts of the electron transport chain, including ATPase activity ('ATPase'), mitochondrial leak ('mito_leak') and oxidation ('mito_oxidation') as well as antioxidant enzymes ('antiox'). All other traits not falling within these categories were placed into 'other'. 

### *Climate Data*

To understand how climate has impacted speciesâ€™ physiological acclimation abilities we used the coordinates reported by each study to extract temperature data from terrestrial and aquatic environments. Only studies on wild populations were used for climate analyses because temperature data at locations was likely reflective of past climate history. Temperature data was extracted using the monthly averages provided by the ERA5 climate model, available from the Copernicus climate data store [@Hersbach2020]. For each population and species in the dataset we extracted a 30-year period (1958-2022) of either surface temperature at 2 meters for terrestrial and freshwater taxa, or sea surface temperature for the marine taxa. We chose a 2 meters resolution because we believed that it more likely to reflects the micro-thermal environment experienced by terrestrial and freshwater ectotherms. 

Using thermal time-series data for each location we summarised various metrics of thermal variability across months and years. We calculated the coefficient of variation ($\frac{SD}{M}$, where SD = standard deviation in temperature and M = the mean temperature for each year). 

### *Meta-Analysis*
We analysed our data using Bayesian multilevel meta-analytic (MLMA) and meta-regression (MLMR) models in R (vers. `r paste0(R.Version()$major, ".", R.Version()$minor)`) using *brms* [vers. `r utils::packageVersion("brms")` @Burkner2018; @Burkner2017; @stan]. We included study, species and phylogeny as random effects to account for non-independence and also explore drivers of variation among $lnRR_{Q_{10}}$ estimates. 


@Guangchuang2017

### *Sensitivity Analyses*
### *Publication Bias*

## *Results*

### *Do terrestrial and aquatic ectotherms differ in their capacity to acclimate?*

```{r lnrrq10, echo = FALSE, message=FALSE, warning=FALSE, results='hide'}
#############
## lnRRQ10 ##
#############
##################################################
# Organise the data and prune tree
##################################################
# Subset the data
lnRRQ10_data <- data_long2 %>% filter(grepl("lnRR", name) & !is.na(effect_size) & !is.na(V) & !V == 0) %>% 
                              mutate(spp = species_full, c_accl_time = acclim_period - mean(acclim_period, na.rm = TRUE))

# Check and prune tree
tree_lnrr <- tree_checks(data = lnRRQ10_data, tree = tree_p0.7, dataCol = "species_full", type = "prune")
tree_checks(data = lnRRQ10_data, tree = tree_lnrr, dataCol = "species_full", type = "check") # Good

# Create the phylo correlation matrix
phylo_cor <- vcv(tree_lnrr, cor = TRUE)
        A <- vcv(tree_lnrr, cor = FALSE) # For bayes, need cov matrix

# Found some other data entry problems from old dataset. Sample sizes are decimals. That's not correct. It has to be an integer. Need to check. These are not the new data that we entered. 
hist(lnRRQ10_data$V)

# Studies with big V, why? Check N
lnRRQ10_data %>% filter(V >= 2)

##################################################
# Model 1.1: Intercept only model. 
##################################################
rerun = FALSE
if(rerun){
  model1.1 <- metafor::rma.mv(effect_size ~ 1, V = V, 
                              random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor), dfs = "contain", 
                              test = "t", data = lnRRQ10_data) 
  
  model1.1_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  1 + (~1 | record_num) + (1 | gr(species_full, cov = A)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A=A), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data)
  
  # Save model1.1
  saveRDS(model1.1, file = "./output/models/lnRRQ10_1.1")
  saveRDS(model1.1_bayes, file = "./output/models/lnRRQ10_1.1_bayes")
} else{ 
  model1.1 <- readRDS("./output/models/lnRRQ10_1.1")
model1.1_bayes <- readRDS("./output/models/lnRRQ10_1.1_bayes")}

# Heterogeneity analysis
   w <- with(lnRRQ10_data, 1/V) # weights
  sv <- sum(w*(dim(lnRRQ10_data)[1]-1)) / (sum(w)^2 + sum(w^2))

# extract posterior sds, but square them to turn to variance
  posteriors_1.1 <- posterior_samples(model1.1_bayes, pars = "^sd")^2
  colnames(posteriors_1.1) <- gsub("__Intercept", "", colnames(posteriors_1.1))
  colnames(posteriors_1.1) <- gsub("sd_", "", colnames(posteriors_1.1))
  
    res <- posteriors_1.1[,"obs"]
   stdy <- posteriors_1.1[,"record_num"]
  phylo <- posteriors_1.1[,"species_full"]
    spp <- posteriors_1.1[,"spp"]
  trait <- posteriors_1.1[,"trait"]
  total <- phylo + spp + res + sv + stdy + trait
 
  # Calculate I2
     tot_i2 <- (sv / total)*100    ; mean(tot_i2)  ; quantile(tot_i2, c(0.025, 0.975))
   phylo_i2 <- (phylo / total)*100 ; mean(phylo_i2); quantile(phylo_i2, c(0.025, 0.975))
     spp_i2 <- (spp / total)*100   ; mean(spp_i2)  ; quantile(spp_i2, c(0.025, 0.975))
    stdy_i2 <- (stdy / total)*100  ; mean(stdy_i2) ; quantile(stdy_i2, c(0.025, 0.975))
   trait_i2 <- (trait / total)*100 ; mean(trait_i2); quantile(trait_i2, c(0.025, 0.975))
     res_i2 <- (res / total)*100   ; mean(res_i2)  ; quantile(res_i2, c(0.025, 0.975))
  
  # Table
     i2_lnrr <- data.frame(name = c("Phylogeny", "Species", "Study", "Trait"),
                           est = c(mean(phylo_i2),mean(spp_i2), mean(stdy_i2), mean(trait_i2)),
                           lci = c(quantile(phylo_i2, c(0.025, 0.975))[1], quantile(spp_i2, c(0.025, 0.975))[1],
                                   quantile(stdy_i2, c(0.025, 0.975))[1], quantile(trait_i2, c(0.025, 0.975))[1]),
                           uci = c(quantile(phylo_i2, c(0.025, 0.975))[2], quantile(spp_i2, c(0.025, 0.975))[2],
                                   quantile(stdy_i2, c(0.025, 0.975))[2], quantile(trait_i2, c(0.025, 0.975))[2]))
     
###################################################
# Model 1.2: Model controlling for acclimation time, 
# type and habitat assuming type can vary by habitat
###################################################

if(rerun){
  # More realistic model with 
  model1.2 <- metafor::rma.mv(effect_size ~  c_accl_time + type + habitat + type:habitat, V = V, 
                              random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor), dfs = "contain", 
                              test = "t", data = lnRRQ10_data)
  
   model1.2_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + type + habitat + type:habitat + (~1 | record_num) + (1 | gr(species_full, cov = A)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A=A), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data)
                                  
  # Save model1.2
  saveRDS(model1.2, file = "./output/models/lnRRQ10_1.2")
  saveRDS(model1.2_bayes, file = "./output/models/lnRRQ10_1.2_bayes")

  } else{
        model1.2 <- readRDS("./output/models/lnRRQ10_1.2")
  model1.2_bayes <- readRDS("./output/models/lnRRQ10_1.2_bayes")
}

####################################################
## Model 1.2: Bayesian Contrasts
###################################################
  posteriors_1.2 <- posterior_samples(model1.2_bayes, pars = "^b")
  f_acute  <- posteriors_1.2[,"b_Intercept"]; pmcmc(f_acute)
  f_acclim <- posteriors_1.2[,"b_Intercept"] + posteriors_1.2[,"b_typeacclim"]
  m_acute  <- posteriors_1.2[,"b_Intercept"] + posteriors_1.2[,"b_habitatm"]
  m_acclim <- posteriors_1.2[,"b_Intercept"] + posteriors_1.2[,"b_habitatm"] + posteriors_1.2[,"b_typeacclim"] + posteriors_1.2[,"b_typeacclim:habitatm"]
  t_acute  <- posteriors_1.2[,"b_Intercept"] + posteriors_1.2[,"b_habitatt"]
  t_acclim <- posteriors_1.2[,"b_Intercept"] + posteriors_1.2[,"b_habitatt"] + posteriors_1.2[,"b_typeacclim"] + posteriors_1.2[,"b_typeacclim:habitatt"]

# Q10 values for each category. Effect sizes are quite small really
   f_acute_Q10 <- exp(f_acute) ; mean(f_acute_Q10); quantile(f_acute_Q10, c(0.025, 0.975))
  f_acclim_Q10 <- exp(f_acclim); mean(f_acclim_Q10); quantile(f_acclim_Q10, c(0.025, 0.975))
   m_acute_Q10 <- exp(m_acute) ; mean(m_acute_Q10); quantile(m_acute_Q10, c(0.025, 0.975))
  m_acclim_Q10 <- exp(m_acclim); mean(m_acclim_Q10); quantile(m_acclim_Q10, c(0.025, 0.975))
   t_acute_Q10 <- exp(t_acute) ; mean(t_acute_Q10); quantile(t_acute_Q10, c(0.025, 0.975))
  t_acclim_Q10 <- exp(t_acclim); mean(t_acclim_Q10); quantile(t_acclim_Q10, c(0.025, 0.975))

# % change in acclimation on log scale
  change_f <- abs(f_acclim - f_acute)*100; quantile(change_f, c(0.025, 0.975))
  change_m <- abs(m_acclim - m_acute)*100; quantile(change_m, c(0.025, 0.975))
  change_t <- abs(t_acclim - t_acute)*100; quantile(change_t, c(0.025, 0.975))

# % change on Q10 scale
  p_change_f_q10 <- exp(f_acclim - f_acute)-1; quantile(p_change_f_q10, c(0.025, 0.975))
  p_change_m_q10 <- exp(m_acclim - m_acute)-1; quantile(p_change_m_q10, c(0.025, 0.975))
  p_change_t_q10 <- exp(t_acclim - t_acute)-1; quantile(p_change_t_q10, c(0.025, 0.975))

####################################################
# Model 1.3's: Trait type varied by acclimation type
# but data is separated by habitat to simplify
####################################################
# Filter to different habitats
   lnRRQ10_data_m <- lnRRQ10_data %>% filter(habitat == "m")
   lnRRQ10_data_f <- lnRRQ10_data %>% filter(habitat == "f")
   lnRRQ10_data_t <- lnRRQ10_data %>% filter(habitat == "t")
  
   # Prune tree
   tree_m <- tree_checks(lnRRQ10_data_m, tree = tree_lnrr, dataCol = "species_full", type = "prune")
   tree_f <- tree_checks(lnRRQ10_data_f, tree = tree_lnrr, dataCol = "species_full", type = "prune")
   tree_t <- tree_checks(lnRRQ10_data_t, tree = tree_lnrr, dataCol = "species_full", type = "prune")
   
   # cor matrices
   m_phylo <- vcv(tree_m, corr = TRUE)
       A_m <- vcv(tree_m, corr = FALSE)
   f_phylo <- vcv(tree_f, corr = TRUE)
       A_f <- vcv(tree_f, corr = FALSE)
   t_phylo <- vcv(tree_t, corr = TRUE)
       A_t <- vcv(tree_t, corr = FALSE)
    
if(rerun){
   # More realistic model with traits in marine species
  model1.3_m <- metafor::rma.mv(effect_size ~  c_accl_time + type + trait_category + type:trait_category, V = V, 
                              random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | spp,
                                            ~1 | trait,
                                            ~1 | obs),
                              R = list(species_full = m_phylo), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_m)
  
   model1.3_m_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + type + trait_category + type:trait_category + (~1 | record_num) + (1 | gr(species_full, cov = A_m)) + (1 | spp) +(1|trait) + (1|obs), data2 = list(A_m=A_m), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_m)
  
    # More realistic model with traits in freshwater species
  model1.3_f <- metafor::rma.mv(effect_size ~  c_accl_time + type + trait_category + type:trait_category, V = V, 
                              random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | spp,
                                            ~1 | trait,
                                            ~1 | obs),
                              R = list(species_full =f_phylo), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_f)
  
   model1.3_f_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + type + trait_category + type:trait_category + (~1 | record_num) + (1 | gr(species_full, cov = A_f)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_f=A_f), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_f)
   
    # More realistic model with traits in terrestrial species
  model1.3_t <- metafor::rma.mv(effect_size ~  c_accl_time + type + trait_category + type:trait_category, V = V, 
                              random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | spp,
                                            ~1 | trait,
                                            ~1 | obs),
                              R = list(species_full =t_phylo), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_t)
  
   model1.3_t_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + type + trait_category + type:trait_category + (~1 | record_num) + (1 | gr(species_full, cov = A_t)) + (1 | spp) + (1 | trait) + (1|obs), data2 = list(A_t=A_t), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_t)
                      
  # Save models
  saveRDS(model1.3_m, file = "./output/models/lnRRQ10_1.3m")
  saveRDS(model1.3_m_bayes, file = "./output/models/lnRRQ10_1.3_bayes_m")
  saveRDS(model1.3_f, file = "./output/models/lnRRQ10_1.3f")
  saveRDS(model1.3_f_bayes, file = "./output/models/lnRRQ10_1.3_bayes_f")
  saveRDS(model1.3_t, file = "./output/models/lnRRQ10_1.3t")
  saveRDS(model1.3_t_bayes, file = "./output/models/lnRRQ10_1.3_bayes_t")

  } else{
        model1.3_m <- readRDS("./output/models/lnRRQ10_1.3m")
  model1.3_m_bayes <- readRDS("./output/models/lnRRQ10_1.3_bayes_m")
        model1.3_f <- readRDS("./output/models/lnRRQ10_1.3f")
  model1.3_f_bayes <- readRDS("./output/models/lnRRQ10_1.3_bayes_f")
        model1.3_t <- readRDS("./output/models/lnRRQ10_1.3t")
  model1.3_t_bayes <- readRDS("./output/models/lnRRQ10_1.3_bayes_t")
}

```

```{r, lncvrq10, echo = FALSE, message=FALSE, warning=FALSE, results='hide'}
#############
  ## lnCVRQ10
#############
##################################################
  # Organise the data and prune tree
#################################################
  lnCVRQ10_data <- data_long2 %>% filter(grepl("lnCVR", name) & !is.na(effect_size) & !is.na(V) & !V == 0) %>% 
                              mutate(spp = species_full, c_accl_time = acclim_period - mean(acclim_period, na.rm = TRUE))

# Check and prune tree
  tree_lncvr <- tree_checks(data = lnCVRQ10_data, tree = tree_p0.7, dataCol = "species_full", type = "prune")
  tree_checks(data = lnCVRQ10_data, tree = tree_lncvr, dataCol = "species_full", type = "check") # Good

# Create the phylo correlation matrix
  phylo_cor_CVR <- vcv(tree_lncvr, cor = TRUE)
          A_CVR <- vcv(tree_lncvr, cor = FALSE) # For bayes, need cov matrix

# Found some other data entry problems from old dataset. Sample sizes are decimals. That's not correct. It has to be an integer. Need to check. These are not the new data that we entered. 
  hist(lnCVRQ10_data$V)

# Studies with big V, why? Check N
  lnCVRQ10_data %>% filter(V >= 2)

###################################################
  # Model 2.1: Intercept only model.
  # Used for heterogeneity analysis
###################################################
rerun = FALSE
if(rerun){
  model2.1 <- metafor::rma.mv(effect_size ~ 1, V = V, 
                              random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | spp,
                                            ~1 | trait,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_CVR), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data) 
  
  model2.1_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  1 + (~1 | record_num) + (1 | gr(species_full, cov = A_CVR)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_CVR=A_CVR), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data)
  
  # Save model1.1
  saveRDS(model2.1, file = "./output/models/lnCVRQ10_2.1")
  saveRDS(model2.1_bayes, file = "./output/models/lnCVRQ10_2.1_bayes")
} else{ 
        model2.1 <- readRDS("./output/models/lnCVRQ10_2.1")
  model2.1_bayes <- readRDS("./output/models/lnCVRQ10_2.1_bayes")
  }

# Heterogeneity analysis
   w_cvr <- with(lnCVRQ10_data, 1/V) # weights
  sv_cvr <- sum(w_cvr*(dim(lnCVRQ10_data)[1]-1)) / (sum(w_cvr)^2 + sum(w_cvr^2))

# extract posterior sds, but square them to turn to variance
  posteriors_2.1 <- posterior_samples(model2.1_bayes, pars = "^sd")^2
  colnames(posteriors_2.1) <- gsub("__Intercept", "", colnames(posteriors_2.1))
  colnames(posteriors_2.1) <- gsub("sd_", "", colnames(posteriors_2.1))
  
    res_cvr <- posteriors_2.1[,"obs"]
   stdy_cvr <- posteriors_2.1[,"record_num"]
  phylo_cvr <- posteriors_2.1[,"species_full"]
    spp_cvr <- posteriors_2.1[,"spp"]
  trait_cvr <- posteriors_2.1[,"trait"]
  total_cvr <- phylo_cvr + spp_cvr + res_cvr + sv_cvr + stdy_cvr + trait_cvr
 
  # Calculate I2
     tot_i2_cvr <- (sv_cvr / total_cvr)*100    ; mean(tot_i2_cvr)  ; quantile(tot_i2_cvr, c(0.025, 0.975))
   phylo_i2_cvr <- (phylo_cvr / total_cvr)*100 ; mean(phylo_i2_cvr); quantile(phylo_i2_cvr, c(0.025, 0.975))
     spp_i2_cvr <- (spp_cvr / total_cvr)*100   ; mean(spp_i2_cvr)  ; quantile(spp_i2_cvr, c(0.025, 0.975))
    stdy_i2_cvr <- (stdy_cvr / total_cvr)*100  ; mean(stdy_i2_cvr) ; quantile(stdy_i2_cvr, c(0.025, 0.975))
   trait_i2_cvr <- (trait_cvr / total_cvr)*100 ; mean(trait_i2_cvr); quantile(trait_i2_cvr, c(0.025, 0.975))
     res_i2_cvr <- (res_cvr / total_cvr)*100   ; mean(res_i2_cvr)  ; quantile(res_i2_cvr, c(0.025, 0.975))
  
  # Table
     i2_lncvr <- data.frame(name = c("Phylogeny", "Species", "Study", "Trait"),
                           est = c(mean(phylo_i2_cvr),mean(spp_i2_cvr), mean(stdy_i2_cvr), mean(trait_i2_cvr)),
                           lci = c(quantile(phylo_i2_cvr, c(0.025, 0.975))[1], quantile(spp_i2_cvr, c(0.025, 0.975))[1],
                                   quantile(stdy_i2_cvr, c(0.025, 0.975))[1], quantile(trait_i2_cvr, c(0.025, 0.975))[1]),
                           uci = c(quantile(phylo_i2_cvr, c(0.025, 0.975))[2], quantile(spp_i2_cvr, c(0.025, 0.975))[2],
                                   quantile(stdy_i2_cvr, c(0.025, 0.975))[2], quantile(trait_i2_cvr, c(0.025, 0.975))[2]))  
  
###################################################
  # Model 2.2: Model controlling for acclimation time, 
  # type and habitat assuming type can vary by habitat
###################################################

if(rerun){
  # More realistic model 
  model2.2 <- metafor::rma.mv(effect_size ~  c_accl_time + type + habitat + type:habitat, V = V, 
                              random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | spp,
                                            ~1 | trait,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_CVR), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data)
  
   model2.2_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + type + habitat + type:habitat + (~1 | record_num) + (1 | gr(species_full, cov = A_CVR)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_CVR=A_CVR), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data)
                                  
  # Save model1.2
  saveRDS(model2.2, file = "./output/models/lnCVRQ10_2.2")
  saveRDS(model2.2_bayes, file = "./output/models/lnCVRQ10_2.2_bayes")

  } else{
        model2.2 <- readRDS("./output/models/lnCVRQ10_2.2")
  model2.2_bayes <- readRDS("./output/models/lnCVRQ10_2.2_bayes")
}

######################################################
  # Bayesian Contrasts
######################################################

  posteriors_2.2 <- posterior_samples(model2.2_bayes, pars = "^b")
  f_acute_cvr  <- posteriors_2.2[,"b_Intercept"]; pmcmc(f_acute_cvr)
  f_acclim_cvr <- posteriors_2.2[,"b_Intercept"] + posteriors_2.2[,"b_typeacclim"]
  m_acute_cvr  <- posteriors_2.2[,"b_Intercept"] + posteriors_2.2[,"b_habitatm"]
  m_acclim_cvr <- posteriors_2.2[,"b_Intercept"] + posteriors_2.2[,"b_habitatm"] + posteriors_2.2[,"b_typeacclim"] + posteriors_2.2[,"b_typeacclim:habitatm"]
  t_acute_cvr  <- posteriors_2.2[,"b_Intercept"] + posteriors_2.2[,"b_habitatt"]
  t_acclim_cvr <- posteriors_2.2[,"b_Intercept"] + posteriors_2.2[,"b_habitatt"] + posteriors_2.2[,"b_typeacclim"] + posteriors_2.2[,"b_typeacclim:habitatt"]

# We'll take the marginalised mean for each type as there is no difference between acclimation and acute really except for in freshwater, but this effect size is so tiny. It's a 10% reduction at high temps and acclim is only a 2% reduction in variance at high temps.
  # First get sample sizes
    N <- lnCVRQ10_data %>% group_by(habitat, type) %>% summarise(n=n())
  
  # Calculated weighted mean by sample size. 
    f_cvr_mean <- (f_acute_cvr*N[1,"n"][[1]] + f_acclim_cvr*N[2,"n"][[1]]) / sum(N[1:2, "n"]); pmcmc(f_cvr_mean)
    m_cvr_mean <- (m_acute_cvr*N[3,"n"][[1]] + m_acclim_cvr*N[3,"n"][[1]]) / sum(N[3:4, "n"]); pmcmc(m_cvr_mean)
    t_cvr_mean <- (t_acute_cvr*N[5,"n"][[1]] + t_acclim_cvr*N[6,"n"][[1]]) / sum(N[5:6, "n"]); pmcmc(t_cvr_mean)
    
```

```{r, wildlnRR10}
#######################################
  ## lnRRQ10 from Wild Populations ##
#######################################
##################################################
  # Organise the data and prune tree
##################################################

# Bring in Climate data
climate <- read.csv("./output/climate_data/temp_timeseries.csv")

# Create a match column.
climate2 <- climate %>% mutate(match = interaction(species, lat, long)) %>% dplyr::select(-c(5:523))

# Subset the data
lnRRQ10_data_wild <- data_long2 %>% filter(grepl("lnRR", name) & !is.na(effect_size) & !is.na(V) & !V == 0 & source == "w") %>% 
                              mutate(spp = species_full, c_accl_time = acclim_period - mean(acclim_period, na.rm = TRUE), match = interaction(spp, lat, long))

# Now, join climate data to full data. This will give us all the climate variability data for each site across time
lnRRQ10_data_wild <- left_join(lnRRQ10_data_wild, climate2, by = "match")

# Check and prune tree
tree_lnrr_wild <- tree_checks(data = lnRRQ10_data_wild, tree = tree_p0.7, dataCol = "species_full", type = "prune")
tree_checks(data = lnRRQ10_data_wild, tree = tree_lnrr, dataCol = "species_full", type = "check") # Good

# Create the phylo correlation matrix
phylo_cor_wild <- vcv(tree_lnrr_wild, cor = TRUE)
        A_wild <- vcv(tree_lnrr_wild, cor = FALSE) # For bayes, need cov matrix

# Scale data
        lnRRQ10_data_wild <- lnRRQ10_data_wild %>% mutate(cv_c = scale(cv),
                                                          acf_all_c = scale(acf_all))
###################################################
  # Model 3.2: Model controlling for acclimation time, 
  # type and habitat assuming type can vary by habitat
###################################################
rerun = TRUE
if(rerun){
  # More realistic model with 
  model3.2          <- metafor::rma.mv(effect_size ~ c_accl_time + type + habitat + type:habitat, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_wild)
  
   model3.2_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + type + habitat + type:habitat + (~1 | record_num) + (1 | gr(species_full, cov = A_wild)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild=A_wild), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_wild)
                                  
  # Save model3.2
  saveRDS(model3.2, file = "./output/models/lnRRQ10_3.2")
  saveRDS(model3.2_bayes, file = "./output/models/lnRRQ10_3.2_bayes")

  } else{
        model3.2 <- readRDS("./output/models/lnRRQ10_3.2")
  model3.2_bayes <- readRDS("./output/models/lnRRQ10_3.2_bayes")
}

####################################################
  ## Model 3.2: Bayesian Contrasts
###################################################
  posteriors_3.2 <- posterior_samples(model3.2_bayes, pars = "^b")
  f_acute_wild  <- posteriors_3.2[,"b_Intercept"]
  f_acclim_wild <- posteriors_3.2[,"b_Intercept"] + posteriors_3.2[,"b_typeacclim"]
  m_acute_wild  <- posteriors_3.2[,"b_Intercept"] + posteriors_3.2[,"b_habitatm"]
  m_acclim_wild <- posteriors_3.2[,"b_Intercept"] + posteriors_3.2[,"b_habitatm"] + posteriors_3.2[,"b_typeacclim"] + posteriors_3.2[,"b_typeacclim:habitatm"]
  t_acute_wild  <- posteriors_3.2[,"b_Intercept"] + posteriors_3.2[,"b_habitatt"]
  t_acclim_wild <- posteriors_3.2[,"b_Intercept"] + posteriors_3.2[,"b_habitatt"] + posteriors_3.2[,"b_typeacclim"] + posteriors_3.2[,"b_typeacclim:habitatt"]

# Q10 values for each category. Effect sizes are quite small really
   f_acute_Q10_wild <- exp(f_acute_wild) ; mean(f_acute_Q10_wild)
  f_acclim_Q10_wild <- exp(f_acclim_wild); mean(f_acclim_Q10_wild)
   m_acute_Q10_wild <- exp(m_acute_wild) ; mean(f_acute_Q10_wild)
  m_acclim_Q10_wild <- exp(m_acclim_wild); mean(f_acclim_Q10_wild)
   t_acute_Q10_wild <- exp(t_acute_wild) ; mean(t_acute_Q10_wild)
  t_acclim_Q10_wild <- exp(t_acclim_wild); mean(t_acclim_Q10_wild)

# % change in acclimation on log scale
  change_f_wild <- abs(f_acclim_wild - f_acute_wild)*100; quantile(change_f_wild, c(0.025, 0.975))
  change_m_wild <- abs(m_acclim_wild - m_acute_wild)*100; quantile(change_m_wild, c(0.025, 0.975))
  change_t_wild <- abs(t_acclim_wild - t_acute_wild)*100; quantile(change_t_wild, c(0.025, 0.975))

# % change on Q10 scale
  p_change_f_q10_wild <- (exp(f_acclim_wild - f_acute_wild)-1)*100; quantile(p_change_f_q10_wild, c(0.025, 0.975))
  p_change_m_q10_wild <- (exp(m_acclim_wild - m_acute_wild)-1)*100; quantile(p_change_m_q10_wild, c(0.025, 0.975))
  p_change_t_q10_wild <- (exp(t_acclim_wild - t_acute_wild)-1)*100; quantile(p_change_t_q10_wild, c(0.025, 0.975))

####################################################
  # Model 3.3: Model environmental variability by acute 
  #  acclim 
####################################################
  rerun = TRUE
if(rerun){
  # More realistic model with 
  model3.3          <- metafor::rma.mv(effect_size ~ c_accl_time + cv_c + type + type:cv_c, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_wild)
  
   model3.3_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + cv_c + type + type:cv_c + (~1 | record_num) + (1 | gr(species_full, cov = A_wild)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild=A_wild), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_wild)
                                  
  # Save model3.3
  saveRDS(model3.3, file = "./output/models/lnRRQ10_3.3")
  saveRDS(model3.3_bayes, file = "./output/models/lnRRQ10_3.3_bayes")

  } else{
        model3.3 <- readRDS("./output/models/lnRRQ10_3.3")
  model3.3_bayes <- readRDS("./output/models/lnRRQ10_3.3_bayes")
  }
  
################################################################
  # Model 3.7: Environmental autocorrelation model by acute/acclim
################################################################
  if(rerun){
  # More realistic model with 
  model3.4          <- metafor::rma.mv(effect_size ~ c_accl_time + acf_all_c + type + type:acf_all_c, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_wild)
  
   model3.4_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + acf_all_c + type + type:acf_all_c + (~1 | record_num) + (1 | gr(species_full, cov = A_wild)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild=A_wild), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_wild)
                                  
  # Save model3.3
  saveRDS(model3.4, file = "./output/models/lnRRQ10_3.4")
  saveRDS(model3.4_bayes, file = "./output/models/lnRRQ10_3.4_bayes")

  } else{
        model3.4 <- readRDS("./output/models/lnRRQ10_3.4")
  model3.4_bayes <- readRDS("./output/models/lnRRQ10_3.4_bayes")
  }
  
################################################################
  # Model 3.5: Environmental variability  model
################################################################
  if(rerun){
  # More realistic model with 
  model3.5          <- metafor::rma.mv(effect_size ~ c_accl_time + cv_c + type, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_wild)
  
   model3.5_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + cv_c + type + (~1 | record_num) + (1 | gr(species_full, cov = A_wild)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild=A_wild), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_wild)
                                  
  # Save model3.5
  saveRDS(model3.5, file = "./output/models/lnRRQ10_3.5")
  saveRDS(model3.5_bayes, file = "./output/models/lnRRQ10_3.5_bayes")

  } else{
        model3.5 <- readRDS("./output/models/lnRRQ10_3.5")
  model3.5_bayes <- readRDS("./output/models/lnRRQ10_3.5_bayes")
  }
  
  
################################################################
  # Model 3.6: Environmental autocorrelation model
################################################################
  
  
  if(rerun){
  # More realistic model with 
  model3.6          <- metafor::rma.mv(effect_size ~ c_accl_time + acf_all_c + type, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_wild)
  
   model3.6_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + acf_all_c + type + (~1 | record_num) + (1 | gr(species_full, cov = A_wild)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild=A_wild), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_wild)
                                  
  # Save model3.6
  saveRDS(model3.6, file = "./output/models/lnRRQ10_3.6")
  saveRDS(model3.6_bayes, file = "./output/models/lnRRQ10_3.6_bayes")

  } else{
        model3.6 <- readRDS("./output/models/lnRRQ10_3.6")
  model3.6_bayes <- readRDS("./output/models/lnRRQ10_3.6_bayes")
  }
  
################################################################
  # Model 3.7: Environmental variability and autocorrelation model
################################################################
  
  if(rerun){
  # More realistic model with 
  model3.7          <- metafor::rma.mv(effect_size ~ c_accl_time + acf_all_c + cv_c + type, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_wild)
  
   model3.7_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + acf_all_c + cv_c + type + (~1 | record_num) + (1 | gr(species_full, cov = A_wild)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild=A_wild), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_wild)
                                  
  # Save model3.7
  saveRDS(model3.7, file = "./output/models/lnRRQ10_3.7")
  saveRDS(model3.7_bayes, file = "./output/models/lnRRQ10_3.7_bayes")

  } else{
        model3.7 <- readRDS("./output/models/lnRRQ10_3.7")
  model3.7_bayes <- readRDS("./output/models/lnRRQ10_3.7_bayes")
  }
  
############################################################################################
# Model 3.8: Acclimatization lnRRQ10 only. Test if environmental predictability explains 
# differently in each habitat
############################################################################################  
  lnRRQ10_data_wild_acclim <- lnRRQ10_data_wild %>%  filter(type == "acclim")
  
  # Create the phylo correlation matrix
  
  # Check and prune tree
tree_lnrr_wild_acclim <- tree_checks(data = lnRRQ10_data_wild_acclim, tree = tree_p0.7, dataCol = "species_full", type = "prune")
tree_checks(data = lnRRQ10_data_wild_acclim, tree = tree_lnrr_wild_acclim, dataCol = "species_full", type = "check")

phylo_cor_wild_acclim <- vcv(tree_lnrr_wild_acclim, cor = TRUE)
        A_wild_acclim <- vcv(tree_lnrr_wild_acclim, cor = FALSE) # For bayes, need cov matrix
  
  
  if(rerun){
  # More realistic model with 
  model3.8  <- metafor::rma.mv(effect_size ~ c_accl_time + acf_all_c + habitat + habitat:acf_all_c, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_acclim), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_wild_acclim)
  
   model3.8_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + acf_all_c + habitat + habitat:acf_all_c + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_acclim)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_acclim=A_wild_acclim), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_wild_acclim)
                                  
  # Save model3.8
  saveRDS(model3.8, file = "./output/models/lnRRQ10_3.8")
  saveRDS(model3.8_bayes, file = "./output/models/lnRRQ10_3.8_bayes")

  } else{
        model3.8 <- readRDS("./output/models/lnRRQ10_3.8")
  model3.8_bayes <- readRDS("./output/models/lnRRQ10_3.8_bayes")
}

#################################################
### Bayesian Slopes from Model 3.8
#################################################
 posteriors3.8 <- posterior_samples(model3.8_bayes, "^b") 
        
    slope_f_3.8 <- posteriors3.8[,"b_acf_all_c"]; pmcmc(slope_f_3.8); quantile(slope_f_3.8, c(0.025, 0.975))
    slope_m_3.8 <- posteriors3.8[,"b_acf_all_c"] + posteriors3.8[,"b_acf_all_c:habitatm"]; pmcmc(slope_m_3.8); quantile(slope_m_3.8, c(0.025, 0.975))
    slope_t_3.8 <- posteriors3.8[,"b_acf_all_c"] + posteriors3.8[,"b_acf_all_c:habitatt"]; pmcmc(slope_t_3.8); quantile(slope_t_3.8, c(0.025, 0.975))
    
############################################################################################
# Model 3.9: Acclimatization lnRRQ10 only. Test if environmental variance explains 
# differently in each habitat
############################################################################################          
        
if(rerun){
  # More realistic model with 
  model3.9  <- metafor::rma.mv(effect_size ~ c_accl_time + cv_c + habitat + habitat:cv_c, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_acclim), dfs = "contain", 
                              test = "t", data = lnRRQ10_data_wild_acclim)
  
   model3.9_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + cv_c + habitat + habitat:cv_c + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_acclim)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_acclim=A_wild_acclim), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnRRQ10_data_wild_acclim)
                                  
  # Save model3.8
  saveRDS(model3.9, file = "./output/models/lnRRQ10_3.9")
  saveRDS(model3.9_bayes, file = "./output/models/lnRRQ10_3.9_bayes")

  } else{
        model3.9 <- readRDS("./output/models/lnRRQ10_3.9")
  model3.9_bayes <- readRDS("./output/models/lnRRQ10_3.9_bayes")
}

#################################################
### Bayesian Slopes from Model 3.9
#################################################
 posteriors <- posterior_samples(model3.9_bayes, "^b") 
        
    slope_f <-     posteriors[,"b_cv_c"]; pmcmc(slope_f); quantile(slope_f, c(0.025, 0.975))
    slope_m <-     posteriors[,"b_cv_c"] + posteriors[,"b_cv_c:habitatm"]; pmcmc(slope_m); quantile(slope_m, c(0.025, 0.975))
    slope_t <-     posteriors[,"b_cv_c"] + posteriors[,"b_cv_c:habitatt"]; pmcmc(slope_t); quantile(slope_t, c(0.025, 0.975))
        
```

```{r wildlncvr}
#######################################
  ## lnCVRQ10 from Wild Populations ##
#######################################
##################################################
  # Organise the data and prune tree
##################################################

# Bring in Climate data
climate <- read.csv("./output/climate_data/temp_timeseries.csv")

# Create a match column.
climate2 <- climate %>% mutate(match = interaction(species, lat, long)) %>% dplyr::select(-c(5:523))

# Subset the data
lnCVRQ10_data_wild <- data_long2 %>% filter(grepl("lnCVR", name) & !is.na(effect_size) & !is.na(V) & !V == 0 & source == "w") %>% 
                              mutate(spp = species_full, 
                                     c_accl_time = acclim_period - mean(acclim_period, na.rm = TRUE), 
                                     match = interaction(spp, lat, long))

# Now, join climate data to full data. This will give us all the climate variability data for each site across time
lnCVRQ10_data_wild <- left_join(lnCVRQ10_data_wild, climate2, by = "match")

# Check and prune tree
tree_lncvr_wild <- tree_checks(data = lnCVRQ10_data_wild, tree = tree_p0.7, dataCol = "species_full", type = "prune")
tree_checks(data = lnCVRQ10_data_wild, tree = tree_lncvr_wild, dataCol = "species_full", type = "check") # Good

# Create the phylo correlation matrix
phylo_cor_wild_cvr <- vcv(tree_lncvr_wild, cor = TRUE)
        A_wild_cvr <- vcv(tree_lncvr_wild, cor = FALSE) # For bayes, need cov matrix

# Scale environment variables
    lnCVRQ10_data_wild <- lnCVRQ10_data_wild %>% mutate(     cv_c = scale(cv),
                                                        acf_all_c = scale(acf_all))
###################################################
  # Model 4.2: Model controlling for acclimation time, 
  # type and habitat assuming type can vary by habitat
###################################################
rerun = FALSE
if(rerun){
  # More realistic model with 
  model4.2          <- metafor::rma.mv(effect_size ~ c_accl_time + type + habitat + type:habitat, V = V,
                              random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_cvr), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data_wild)
  
   model4.2_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + type + habitat + type:habitat + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_cvr)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_cvr=A_wild_cvr), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data_wild)
                                  
  # Save model3.2
  saveRDS(model4.2, file = "./output/models/lnCVRQ10_4.2")
  saveRDS(model4.2_bayes, file = "./output/models/lnCVRQ10_4.2_bayes")

  } else{
        model4.2 <- readRDS("./output/models/lnCVRQ10_4.2")
  model4.2_bayes <- readRDS("./output/models/lnCVRQ10_4.2_bayes")
}

####################################################
  ## Model 4.2: Bayesian Contrasts
###################################################
  posteriors_4.2 <- posterior_samples(model4.2_bayes, pars = "^b")
  f_acute_wild_cvr  <- posteriors_4.2[,"b_Intercept"]
  f_acclim_wild_cvr <- posteriors_4.2[,"b_Intercept"] + posteriors_4.2[,"b_typeacclim"]
  m_acute_wild_cvr  <- posteriors_4.2[,"b_Intercept"] + posteriors_4.2[,"b_habitatm"]
  m_acclim_wild_cvr <- posteriors_4.2[,"b_Intercept"] + posteriors_4.2[,"b_habitatm"] + posteriors_4.2[,"b_typeacclim"] + posteriors_4.2[,"b_typeacclim:habitatm"]
  t_acute_wild_cvr  <- posteriors_4.2[,"b_Intercept"] + posteriors_4.2[,"b_habitatt"]
  t_acclim_wild_cvr <- posteriors_4.2[,"b_Intercept"] + posteriors_4.2[,"b_habitatt"] + posteriors_4.2[,"b_typeacclim"] + posteriors_4.2[,"b_typeacclim:habitatt"]

# CVRQ10 values for each category.
   f_acute_Q10_wild_cvr <- exp(f_acute_wild_cvr) ; mean(f_acute_Q10_wild_cvr)
  f_acclim_Q10_wild_cvr <- exp(f_acclim_wild_cvr); mean(f_acclim_Q10_wild_cvr)
   m_acute_Q10_wild_cvr <- exp(m_acute_wild_cvr) ; mean(f_acute_Q10_wild_cvr)
  m_acclim_Q10_wild_cvr <- exp(m_acclim_wild_cvr); mean(f_acclim_Q10_wild_cvr)
   t_acute_Q10_wild_cvr <- exp(t_acute_wild_cvr) ; mean(t_acute_Q10_wild_cvr)
  t_acclim_Q10_wild_cvr <- exp(t_acclim_wild_cvr); mean(t_acclim_Q10_wild_cvr)

# % change in acclimation on log scale
  change_f_wild_cvr <- abs(f_acclim_wild_cvr - f_acute_wild_cvr)*100; quantile(change_f_wild_cvr, c(0.025, 0.975))
  change_m_wild_cvr <- abs(m_acclim_wild_cvr - m_acute_wild_cvr)*100; quantile(change_m_wild_cvr, c(0.025, 0.975))
  change_t_wild_cvr <- abs(t_acclim_wild_cvr - t_acute_wild_cvr)*100; quantile(change_t_wild_cvr, c(0.025, 0.975))

# % change on Q10 scale
  p_change_f_q10_wild_cvr <- (exp(f_acclim_wild_cvr - f_acute_wild_cvr)-1)*100; quantile(p_change_f_q10_wild_cvr, c(0.025, 0.975))
  p_change_m_q10_wild_cvr <- (exp(m_acclim_wild_cvr - m_acute_wild_cvr)-1)*100; quantile(p_change_m_q10_wild_cvr, c(0.025, 0.975))
  p_change_t_q10_wild_cvr <- (exp(t_acclim_wild_cvr - t_acute_wild_cvr)-1)*100; quantile(p_change_t_q10_wild_cvr, c(0.025, 0.975))

####################################################
  # Model 4.3: Model environmental variability by acute/acclim
####################################################
  rerun = TRUE
if(rerun){
  # More realistic model with 
  model4.3          <- metafor::rma.mv(effect_size ~ c_accl_time + cv_c + type + type:cv_c, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_cvr), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data_wild)
  
   model4.3_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + cv_c + type + type:cv_c + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_cvr)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_cvr=A_wild_cvr), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data_wild)
                                  
  # Save model4.3
  saveRDS(model4.3, file = "./output/models/lnCVRQ10_4.3")
  saveRDS(model4.3_bayes, file = "./output/models/lnCVRQ10_4.3_bayes")

  } else{
        model4.3 <- readRDS("./output/models/lnCVRQ10_4.3")
  model4.3_bayes <- readRDS("./output/models/lnCVRQ10_4.3_bayes")
  }
  
################################################################
  # Model 4.4: Environmental autocorrelation model by acute/acclim
################################################################
  if(rerun){
  # More realistic model with 
  model4.4          <- metafor::rma.mv(effect_size ~ c_accl_time + acf_all_c + type + type:acf_all_c, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_cvr), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data_wild)
  
   model4.4_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + acf_all_c + type + type:acf_all_c + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_cvr)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_cvr=A_wild_cvr), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data_wild)
                                  
  # Save model3.3
  saveRDS(model4.4, file = "./output/models/lnCVRQ10_4.4")
  saveRDS(model4.4_bayes, file = "./output/models/lnCVRQ10_4.4_bayes")

  } else{
        model4.4 <- readRDS("./output/models/lnCVRQ10_4.4")
  model4.4_bayes <- readRDS("./output/models/lnCVRQ10_4.4_bayes")
  }
  
################################################################
  # Model 4.5: Environmental variability
################################################################
if(rerun){
  # More realistic model with 
  model4.5          <- metafor::rma.mv(effect_size ~ c_accl_time + cv_c + type, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_cvr), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data_wild)
  
   model4.5_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + cv_c + type + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_cvr)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_cvr=A_wild_cvr), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data_wild)
                                  
  # Save model4.5
  saveRDS(model4.5, file = "./output/models/lnCVRQ10_4.5")
  saveRDS(model4.5_bayes, file = "./output/models/lnCVRQ10_4.5_bayes")

  } else{
        model4.5 <- readRDS("./output/models/lnCVRQ10_4.5")
  model4.5_bayes <- readRDS("./output/models/lnCVRQ10_4.5_bayes")
  }
  
################################################################
  # Model 4.6: Environmental autocorrelation model 
################################################################
  if(rerun){
  # More realistic model with 
  model4.6          <- metafor::rma.mv(effect_size ~ c_accl_time + acf_all_c + type, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_cvr), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data_wild)
  
   model4.6_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + acf_all_c + type + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_cvr)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_cvr=A_wild_cvr), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data_wild)
                                  
  # Save model4.6
  saveRDS(model4.6, file = "./output/models/lnCVRQ10_4.6")
  saveRDS(model4.6_bayes, file = "./output/models/lnCVRQ10_4.6_bayes")

  } else{
        model4.6 <- readRDS("./output/models/lnCVRQ10_4.6")
  model4.6_bayes <- readRDS("./output/models/lnCVRQ10_4.6_bayes")
  }
  
################################################################
  # Model 4.7: Environmental autocorrelation and variability
################################################################
 if(rerun){
  # More realistic model with 
  model4.7          <- metafor::rma.mv(effect_size ~ c_accl_time + acf_all_c + cv_c + type, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_cvr), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data_wild)
  
   model3.7_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + acf_all_c + cv_c + type + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_cvr)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_cvr=A_wild_cvr), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data_wild)
                                  
  # Save model4.7
  saveRDS(model4.7, file = "./output/models/lnCVRQ10_4.7")
  saveRDS(model4.7_bayes, file = "./output/models/lnCVRQ10_4.7_bayes")

  } else{
        model4.7 <- readRDS("./output/models/lnCVRQ10_4.7")
  model4.7_bayes <- readRDS("./output/models/lnCVRQ10_4.7_bayes")
  }
  
  
############################################################################################
  # Model 4.8: Acclimatization lnCVRQ10 only. Test if environmental predictability explains 
  # differently in each habitat
############################################################################################  
  lnCVRQ10_data_wild_acclim <- lnCVRQ10_data_wild %>%  filter(type == "acclim")
  
  # Create the phylo correlation matrix
  
  # Check and prune tree
tree_lncvr_wild_acclim <- tree_checks(data = lnCVRQ10_data_wild_acclim, tree = tree_p0.7, dataCol = "species_full", type = "prune")
tree_checks(data = lnCVRQ10_data_wild_acclim, tree = tree_lncvr_wild_acclim, dataCol = "species_full", type = "check")

phylo_cor_wild_acclim <- vcv(tree_lncvr_wild_acclim, cor = TRUE)
        A_wild_acclim <- vcv(tree_lncvr_wild_acclim, cor = FALSE) # For bayes, need cov matrix
  
  
  if(rerun){
  # More realistic model with 
  model4.8  <- metafor::rma.mv(effect_size ~ c_accl_time + acf_all_c + habitat + habitat:acf_all_c, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_acclim), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data_wild_acclim)
  
   model4.8_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + acf_all_c + habitat + habitat:acf_all_c + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_acclim)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_acclim=A_wild_acclim), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data_wild_acclim)
                                  
  # Save model4.8
  saveRDS(model4.8, file = "./output/models/lnRRQ10_4.8")
  saveRDS(model4.8_bayes, file = "./output/models/lnRRQ10_4.8_bayes")

  } else{
        model4.8 <- readRDS("./output/models/lnRRQ10_4.8")
  model4.8_bayes <- readRDS("./output/models/lnRRQ10_4.8_bayes")
}
  
        
#################################################
### Bayesian Slopes from Model 4.8
#################################################
 posteriors4.8 <- posterior_samples(model4.8_bayes, "^b") 
        
    slope_f_4.8 <- posteriors4.8[,"b_acf_all_c"]; mean(slope_f_4.8); pmcmc(slope_f_4.8); quantile(slope_f_4.8, c(0.025, 0.975))
    slope_m_4.8 <- posteriors4.8[,"b_acf_all_c"] + posteriors4.8[,"b_acf_all_c:habitatm"]; mean(slope_m_4.8); pmcmc(slope_m_4.8); quantile(slope_m_4.8, c(0.025, 0.975))
    slope_t_4.8 <- posteriors4.8[,"b_acf_all_c"] + posteriors4.8[,"b_acf_all_c:habitatt"]; mean(slope_t_4.8); pmcmc(slope_t_4.8); quantile(slope_t_4.8, c(0.025, 0.975))
    
############################################################################################
# Model 4.9: Acclimatization lnCVRQ10 only. Test if environmental variance explains 
# differently in each habitat
############################################################################################          
        
if(rerun){
  # More realistic model with 
  model4.9  <- metafor::rma.mv(effect_size ~ c_accl_time + cv_c + habitat + habitat:cv_c, V = V,
                                       random = list(~1 | record_num,
                                            ~1 | species_full,
                                            ~1 | trait,
                                            ~1 | spp,
                                            ~1 | obs),
                              R = list(species_full = phylo_cor_wild_acclim), dfs = "contain", 
                              test = "t", data = lnCVRQ10_data_wild_acclim)
  
   model4.9_bayes <- brms::brm(effect_size | se(sqrt(V)) ~  c_accl_time + cv_c + habitat + habitat:cv_c + (~1 | record_num) + (1 | gr(species_full, cov = A_wild_acclim)) + (1 | spp) + (1|trait) + (1|obs), data2 = list(A_wild_acclim=A_wild_acclim), family = gaussian(), prior = c(prior(normal(0, 10), "Intercept"), prior(student_t(3, 0, 10), "sd")), control = list(adapt_delta = 0.98, max_treedepth = 12), chains = 4, thin = 5, iter = 5000, warmup = 1000, cores = 4, data = lnCVRQ10_data_wild_acclim)
                                  
  # Save model3.8
  saveRDS(model4.9, file = "./output/models/lnRRQ10_4.9")
  saveRDS(model4.9_bayes, file = "./output/models/lnRRQ10_4.9_bayes")

  } else{
        model4.9 <- readRDS("./output/models/lnRRQ10_4.9")
  model4.9_bayes <- readRDS("./output/models/lnRRQ10_4.9_bayes")
}
               
    
#################################################
### Bayesian Slopes from Model 4.9
#################################################
 posteriors4.9 <- posterior_samples(model4.9_bayes, "^b") 
        
    slope_f_4.9 <- posteriors4.9[,"b_cv_c"]; mean(slope_f_4.9); pmcmc(slope_f_4.9); quantile(slope_f_4.9, c(0.025, 0.975))
    slope_m_4.9 <- posteriors4.9[,"b_cv_c"] + posteriors4.9[,"b_cv_c:habitatm"]; mean(slope_m_4.9); pmcmc(slope_m_4.9); quantile(slope_m_4.9, c(0.025, 0.975))
    slope_t_4.9 <- posteriors4.9[,"b_cv_c"] + posteriors4.9[,"b_cv_c:habitatt"]; mean(slope_t_4.9); pmcmc(slope_t_4.9); quantile(slope_t_4.9, c(0.025, 0.975))
```



```{r, fig1, fig.align='center', fig.cap= "Acute and Acclimation lnRR Q10 across marine, freshwater and terrestrial environments"}
 col <- c("#0871B9", "#F3B40D", "#1BB908")
p1.2 <- orchaRd::orchard_plot(model1.2, mod = "habitat", group  = "record_num", at = list(type = c("acute", "acclim")), by = "type", weights = "prop", data = lnRRQ10_data, xlab = TeX("$lnRR_{Q_{10}}$"), angle = 45, legend.pos = "top.left", trunk.size = 5) + scale_x_discrete(labels = c("T" = "Terrestrial","M" = "Marine" ,"F" = "Freshwater")) +
  theme(legend.direction = "vertical") +
  geom_segment(aes(x = 2.92, y = 2, xend = 3.07, yend = 2), 
                            arrow = arrow(angle = 90, ends = "both", length = unit(0.01, "npc"))) +
  geom_segment(aes(x = 1.92, y = 2, xend = 2.07, yend = 2), 
                            arrow = arrow(angle = 90, ends = "both", length = unit(0.01, "npc"))) +
  geom_segment(aes(x = 0.92, y = 2, xend = 1.07, yend = 2), 
                            arrow = arrow(angle = 90, ends = "both", length = unit(0.01, "npc"))) +
annotate("text", x = 1, y = 2.10, 
         label =TeX(paste0("$\\beta = $", round(model1.2$b[3], 2), "[", round(model1.2$ci.lb[3], 2)," to ", round(model1.2$ci.ub[3], 2), "] ")), hjust = 0, size = 6) + 
annotate("text", x = 1.01, y = 4.60, 
         label =paste0(round(mean(change_f), 2), "%"), hjust = 0, size = 6) + labs(shape = "Type") +
  geom_segment(aes(x = 0.92, y = 5.6, xend = 1.07, yend = 5.6), 
                            arrow = arrow(angle = 45, ends = "first", length = unit(0.01, "npc"))) +
  annotate("text", x = 0.85, y = 3, label = "P < 0.001", hjust = 0, size = 6) + 
  
  
  annotate("text", x = 2, y = 2.10, 
         label =TeX(paste0("$\\beta = $", round(mean(m_acclim - m_acute), 2), "[", round(quantile(m_acclim - m_acute, 0.025), 2)," to ", round(quantile(m_acclim - m_acute, 0.975),2), "] ")), hjust = 0, size = 6) + 
annotate("text", x = 2.01, y = 4.60, 
         label =paste0(round(mean(change_m), 2), "%"), hjust = 0, size = 6) +
  geom_segment(aes(x = 1.92, y = 5.6, xend = 2.07, yend = 5.6), 
                            arrow = arrow(angle = 45, ends = "first", length = unit(0.01, "npc"))) +
  annotate("text", x = 1.85, y = 3, label = "P = 0.01", hjust = 0, size = 6) +
  
  annotate("text", x = 3, y = 2.10, 
         label =TeX(paste0("$\\beta = $", round(mean(t_acclim - t_acute), 2), "[", round(quantile(t_acclim - t_acute, 0.025), 2)," to ", round(quantile(t_acclim - t_acute, 0.975),2), "] ")), hjust = 0, size = 6) + 
annotate("text", x = 3.01, y = 4.60, 
         label =paste0(round(mean(change_t), 2), "%"), hjust = 0, size = 6) +
  geom_segment(aes(x = 2.92, y = 5.6, xend = 3.07, yend = 5.6), 
                            arrow = arrow(angle = 45, ends = "last", length = unit(0.01, "npc"))) +
  annotate("text", x = 2.85, y = 3, label = "P = 0.36", hjust = 0, size = 6) + scale_fill_manual(values = c(col))
    
  
  p1.2 <- p1.2 + theme_classic() + theme(axis.title  = element_text(size = 24),
        axis.text = element_text(size = 15))
  
  
   p1.2.2 <- p1.2 + ylim(c(0,1)) + theme(legend.position = 'none')
  ggsave(p1.2, filename = "./output/figures/fig1.png", width = 11.5, height = 8)
  ggsave(p1.2.2, filename = "./output/figures/fig1.1.png")
```

```{r, fig2, fig.align='center', fig.cap= "lnCVR Q10 across marine, freshwater and terrestrial environments"}

# Clear from the model that there really is no difference between the change in variance for acute or acclimation CVR. But, there is a clear reduction in between individual variance for terrestrial species. As temperature get hotter then the variance in physiological rates decreases. This is not true of aquatic systems. 
p2 <- orchard_plot(model2.2, xlab = TeX("$lnCVR_{Q_{10}}$"), mod = "habitat", group  = "record_num", weights = "prop", data = lnCVRQ10_data, angle = 45, trunk.size = 5) +
            scale_x_discrete(labels = c("T" = "Terrestrial","M" = "Marine" ,"F" = "Freshwater")) + annotate("text", x = 1.3, y = -5.2, 
         label =TeX(paste0("$\\mu = $", round(mean(f_cvr_mean), 2), "[", round(quantile(f_cvr_mean, 0.025), 2)," to ", round(quantile(f_cvr_mean, 0.975),2), "] ")), hjust = 0, size = 6) + 
annotate("text", x = 1.15, y = -3.7, label = paste0("P = ", round(pmcmc(f_cvr_mean), digit = 2)), hjust = 0, size = 6) + 
annotate("text", x = 1.15, y = -5, 
         label =paste0(round(mean(exp(f_cvr_mean)-1)*100, 2), "%"), hjust = 0, size = 6) + 
annotate("text", x = 2.3, y = -5.2, 
         label =TeX(paste0("$\\mu = $", round(mean(m_cvr_mean), 2), "[", round(quantile(m_cvr_mean, 0.025), 2)," to ", round(quantile(m_cvr_mean, 0.975),2), "] ")), hjust = 0, size = 6) + 
annotate("text", x = 2.15, y = -3.7, label = paste0("P = ", round(pmcmc(m_cvr_mean), digit = 2)), hjust = 0, size = 6) + 
annotate("text", x = 2.15, y = -5, 
         label =paste0(round(mean(exp(m_cvr_mean)-1)*100, 2), "%"), hjust = 0, size = 6) + annotate("text", x = 3.3, y = -5.2, 
         label =TeX(paste0("$\\mu = $", round(mean(t_cvr_mean), 2), "[", round(quantile(t_cvr_mean, 0.025), 2)," to ", round(quantile(t_cvr_mean, 0.975),2), "] ")), hjust = 0, size = 6) + 
annotate("text", x = 3.15, y = -5, 
         label =paste0(round(mean(exp(t_cvr_mean)-1)*100, 2), "%"), hjust = 0, size = 6) + labs(shape = "Type") +
  annotate("text", x = 3.15, y = -3.7, label = paste0("P = ", round(pmcmc(t_cvr_mean), digit = 3)), hjust = 0, size = 6) + scale_fill_manual(values = c(col))
 
  
p2 <- p2 + theme_classic() + theme(axis.title  = element_text(size = 24),
        axis.text = element_text(size = 15))
   p2.2 <- p2 + ylim(c(-0.5,0.10)) + theme(legend.position = 'none')
  
   ggsave(p2, filename = "./output/figures/fig2.png", width = 11.5, height = 8)
  ggsave(p2.2, filename = "./output/figures/fig2.2.png")
```

```{r, fig3, fig.align='center', fig.cap="Acute and Acclimation lnRR q10 across traits for A) marine, B) freshwater and C) terrestrial systems"}

orchard_plot(model1.3, mod = "trait_category",  group = "record_num",  data = lnRRQ10_data) 

ptm <- orchard_plot(model1.3_m, mod = "trait_category", at = list(type = c("acute", "acclim")), by = "type", group = "record_num", weights = "prop", data = lnRRQ10_data_m, xlab = TeX("$lnRR_{Q_{10}}$"), angle = 0) +
  scale_x_discrete(labels = c("Mito_leak" = "Proton Leak",
                              "Metabolic_enzyme" = "Metabolic Enzymes",
                              "Rest_MR" = "Resting Metabolic Rate",
                              "Max_MR" = "Maximum Metabolic Rate",
                              "Mito_oxidation" = "OXPHOS"))
ptm$layers[[1]] <- NULL # Lets just remove the data point geom layer as it's too busy


ptf <- orchard_plot(model1.3_f, mod = "trait_category", at = list(type = c("acute", "acclim")), by = "type", group = "record_num", weights = "prop", data = lnRRQ10_data_f, xlab = TeX("$lnRR_{Q_{10}}$"), angle = 0) +
  scale_x_discrete(labels = c("Mito_leak" = "Proton Leak",
                              "Metabolic_enzyme" = "Metabolic Enzymes",
                              "Rest_MR" = "Resting Metabolic Rate",
                              "Max_MR" = "Maximum Metabolic Rate",
                              "Mito_oxidation" = "OXPHOS"))
ptf$layers[[1]] <- NULL # Lets just remove the data point geom layer as it's too busy


ptt <- orchard_plot(model1.3_t, mod = "trait_category", at = list(type = c("acute", "acclim")), by = "type", group = "record_num", weights = "prop", data = lnRRQ10_data_t, xlab = TeX("$lnRR_{Q_{10}}$"), angle = 0)
ptt$layers[[1]] <- NULL # Lets just remove the data point geom layer as it's too busy

lnRRQ10_data %>% group_by(habitat, type, trait_category) %>% summarise(n = n()) %>% data.frame()

```

```{r, fig4, fig.align='center', fig.cap= "I2 estimates"}


p4 <- ggplot(i2_lnrr, aes(x = est, y = name)) + xlim(0, 50) + geom_point(size = 5) + geom_errorbar(aes(xmin = lci, xmax = uci), width = 0.15) + theme_bw() + labs(x = "Percentage of Variation (%)") + theme(axis.title.y = element_blank(), axis.text = element_text(size = 20), axis.title = element_text(size = 24)) + geom_text(aes(label = paste0(round(est, 2), "% ", "[", round(lci, 2), " - ", round(uci, 2), "%]")), position = position_nudge(x = 5, y = 0.2)) + annotate("text", x = 30, y = 1.5, label = TeX(paste0("$I^2_{sv}$ = ", round(mean(tot_i2), 2), "%")), size = 12)

p4
ggsave(p4, filename = "./output/figures/fig4.png")

```

```{r, fig5, fig.align='center', fig.cap= "I2 estimates lnCVR"}
p5 <- ggplot(i2_lncvr, aes(x = est, y = name)) + xlim(0, 50) + geom_point(size = 5) + geom_errorbar(aes(xmin = lci, xmax = uci), width = 0.15) + theme_bw() + labs(x = "Percentage of Variation (%)") + theme(axis.title.y = element_blank(), axis.text = element_text(size = 20), axis.title = element_text(size = 24)) + geom_text(aes(label = paste0(round(est, 2), "% ", "[", round(lci, 2), " - ", round(uci, 2), "%]")), position = position_nudge(x = 5, y = 0.2)) + annotate("text", x = 30, y = 1.5, label = TeX(paste0("$I^2_{sv}$ = ", round(mean(tot_i2_cvr), 2), "%")), size = 12)

p5
ggsave(p5, filename = "./output/figures/fig5.png")
```

```{r, fig6, fig.align='center', fig.cap= "Bubble plot environment lnRR wild populations"}
p6 <- bubble_plot(model3.5, mod = "cv_c", group  = "record_num", data = lnRRQ10_data_wild, ylab = TeX("$lnRR_{Q_{10}}$"), xlab = "Thermal Coefficient of Variation (CV)") +annotate("text", x = 1, y = 3, label = TeX(paste0("$\\beta = $", round(model3.5$b[3], 3), ", 95%CI: ", round(model3.5$ci.lb[3],3), " to ", round(model3.5$ci.ub[3], 3), "; P = ", round(model3.5$pval[3],3)))) + theme_classic() + theme(legend.position = "none", axis.text = element_text(size = 12), axis.title = element_text(size = 18))

p7 <- bubble_plot(model3.6, mod = "acf_all_c", group  = "record_num", data = lnRRQ10_data_wild, ylab = TeX("$lnRR_{Q_{10}}$"), xlab = "Thermal Predictability") + theme(axis.title.y = element_blank()) +annotate("text", x = -3, y = 3, label = TeX(paste0("$\\beta = $", round(model3.6$b[3], 3), ", 95%CI: ", round(model3.6$ci.lb[3],3), " to ", round(model3.6$ci.ub[3], 3), "; P = ", round(model3.6$pval[3],3)))) + theme_classic() + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 18))
  
p67 <- (p6 | p7) + plot_annotation(tag_levels = "A")
  
ggsave(p67, filename = "./output/figures/fig6.png", height = 10, width = 30, units = "cm")
```

```{r, fig7, fig.align='center', fig.cap= "Bubble plot environment lnCVR wild populations"}
p8 <- bubble_plot(model4.5, mod = "cv_c", group  = "record_num", data = lnCVRQ10_data_wild, ylab = TeX("$lnCVR_{Q_{10}}$"), xlab = "Thermal Coefficient of Variation (CV)", k = FALSE) +annotate("text", x = 1, y = -5, label = TeX(paste0("$\\beta = $", round(model4.5$b[3], 3), ", 95%CI: ", round(model4.5$ci.lb[3],3), " to ", round(model4.5$ci.ub[3], 3), " P = ", round(model4.5$pval[3],3)))) + theme_classic() + theme(legend.position = "none", axis.text = element_text(size = 12), axis.title = element_text(size = 18)) + ylim(c(-6, 3))

p9 <- bubble_plot(model4.6, mod = "acf_all_c", group  = "record_num", data = lnCVRQ10_data_wild, ylab = TeX("$lnCVR_{Q_{10}}$"), xlab = "Thermal Predictability", k = FALSE) + theme(axis.title.y = element_blank()) +annotate("text", x = -3, y = -5, label = TeX(paste0("$\\beta = $", round(model4.6$b[3], 3), ", 95%CI: ", round(model4.6$ci.lb[3],3), " to ", round(model4.6$ci.ub[3], 3), " P = ", round(model4.6$pval[3],3)))) + theme_classic() + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 18)) + ylim(c(-6, 3))
  
p89 <- (p8 | p9) + plot_annotation(tag_levels = "A")
  
ggsave(p89, filename = "./output/figures/fig7.png", height = 10, width = 30, units = "cm")
```

```{r, fig8, fig.align='center', fig.cap= "Bubble plot environment lnRR for wild populations by habitat"}

 col <- c("#0871B9", "#F3B40D", "#1BB908")
p8.1 <- bubble_plot(model3.9, mod = "cv_c", group = "record_num", by = "habitat", data = lnRRQ10_data_wild_acclim, ylab = TeX("$lnRR_{Q_{10}}$"), xlab = "Thermal Coefficient of Variation (CV)", condition.nrow = 1) + theme_classic() + theme(legend.position = "none", strip.background = element_blank())  + scale_fill_manual(values = c(col))

p8.2 <- bubble_plot(model3.8, mod = "acf_all_c", group = "record_num", by = "habitat", data = lnRRQ10_data_wild_acclim, ylab = TeX("$lnRR_{Q_{10}}$"), xlab = "Thermal Predictability", condition.nrow = 1) + theme_classic() + theme(legend.position = "bottom", strip.background = element_blank(), strip.text = element_blank())+ scale_fill_manual(values = c(col))

p8.1.2 <- p8.1 / p8.2

ggsave(p8.1.2, filename = "./output/figures/fig8.png")
```

```{r, fig9, fig.align='center', fig.cap= "Bubble plot environment lnRR for wild populations by habitat"}

 col <- c("#0871B9", "#F3B40D", "#1BB908")
p9.1 <- bubble_plot(model4.9, mod = "cv_c", group = "record_num", by = "habitat", data = lnRRQ10_data_wild_acclim, ylab = TeX("$lnCVR_{Q_{10}}$"), xlab = "Thermal Coefficient of Variation (CV)", condition.nrow = 1, k.pos = "bottom.left") + theme_classic() + theme(legend.position = "none", strip.background = element_blank())  + scale_fill_manual(values = c(col))

p9.2 <- bubble_plot(model4.8, mod = "acf_all_c", group = "record_num", by = "habitat", data = lnRRQ10_data_wild_acclim, ylab = TeX("$lnCVR_{Q_{10}}$"), xlab = "Thermal Predictability", condition.nrow = 1, k.pos = "bottom.left") + theme_classic() + theme(legend.position = "bottom", strip.background = element_blank(), strip.text = element_blank())+ scale_fill_manual(values = c(col))

p91.2 <- p9.1 / p9.2

ggsave(p91.2, filename = "./output/figures/fig9.png")
```

### *Does climate variability predict acclimation capacity among aquatic and terrestrial ectotherms?*
### *Does between-individual variation in acclimation capacities differ across terrestrial and aquatic ectotherms?*

```{r figphylogeny, fig.wdith = 10, fig.height=9, fig.cap="Phylogenetic tree"}
 # Map data to tree. Just one variable for now
      d <- ggtree(tree, layout="circular") %<+% tree_data 

      # Plot the tree
      scales1 <- c("#053061", "#D1E5F0", "#67001F")
      scales2 <- c("#053061", "#E7E0DB", "#67001F")
      p1 <- d + 
            geom_tiplab(size=2, offset = 10) + 
            geom_tippoint(aes(color=habitat), size = 2) +
            labs(color = "Habitat") + 
            scale_colour_manual(values = scales1)
      
      # Create the data matrix that can be used to plot data as a heatmap around the phylogeny
      matrix_data <- as.data.frame(data_wide %>%
                  mutate(trait_category = ifelse(trait_category %in% 
                                                   c("ATPase", "mito_leak", "mito_oxidation"), "Mito. Function", trait_category)) %>%
                  mutate(trait_category = ifelse(trait_category %in% c("endurance", "sprint"), "Performance", trait_category))    %>%
                  mutate(trait_category = ifelse(trait_category %in% c("muscle", "cardiac"), "Muscle Function", trait_category))  %>%
                  mutate(trait_category = ifelse(trait_category %in% c("rest_MR", "max_MR"), "Metabolic Rate", trait_category))   %>%
                  group_by(species_full, trait_category)   %>% 
                  summarise(n = n())                       %>% 
                  spread(trait_category, n, fill = 0))
      
      row.names(matrix_data) <- matrix_data$species_full
      matrix_data <- matrix_data[,c(2:8)]
      
      colnames(matrix_data)[c(1,3,6)] <- c("Antioxidants", "Metabolic Enzymes", "Other")
      
      # Alternatively, summarise total effect sizes per species for acute and acclimation
      matrix_data2 <- data_long %>% filter(grepl("lnRR_Q10", name)) %>% 
                      group_by(species_full, type) %>% 
                      summarise(n = n()) %>% 
                      spread(type, n, fill = 0) %>% data.frame()
                     # mutate(acclim = as.character(cut(acclim, breaks = c(0,15, 20, 25, 30, 40, 50))),
                      #        acute = as.character(cut(acute, breaks = c(0,15, 20, 25, 30, 40, 50)))) 
                      
      row.names(matrix_data2) <- matrix_data2$species_full
      matrix_data2 <- matrix_data2[,2:3]
      
      
      # Plot a heatmap of N for each trait around the phylogeny.
   phylo <-   gheatmap(p1, data.matrix(matrix_data2), offset = 0,  
               colnames_position="bottom", legend_title = "N", 
               colnames_angle=360, colnames_offset_y = 0, colnames_offset_x = -1.5, 
               hjust=0, font.size=3, width = 0.35) + 
                scale_fill_viridis(alpha = 0.6) + labs(fill="# of Effects")
   
   phylo
ggsave(filename = "fig4.png", path = "./output/figures/", phylo, device = "png", width = 10, height = 9, units = "in")
``` 

## References